#7.自定义启动快照

##### 发布时间：2015-09-25 · 标签： [internals](https://v8.dev/blog/tags/internals)

##### 原文地址：https://v8.dev/blog/custom-startup-snapshots

JavaScript规范包含许多内置功能，从数学函数到功能齐全的正则表达式引擎。每个新创建的V8上下文都从一开始就提供这些功能。为此，全局对象（例如，浏览器中的窗口对象）和所有内置功能必须在创建上下文时设置并初始化为V8的堆。从头开始这需要相当长的时间。

幸运的是，V8使用了一个快捷方式来加快速度：就像解冻冷冻比萨饼一样快速吃饭，我们将以前准备好的快照直接反序列化到堆中以获得初始化的上下文。在普通的电脑上，这可以节省从40毫秒到小于2毫秒的创建上下文的时间。在手机上，这可能意味着10 - 270ms之间的差异。

嵌入V8的Chrome以外的应用程序可能需要的不仅仅是普通的Javascript。在“真正”的程序运行之前，许多人在启动时加载其他库脚本。例如，基于V8的简单TypeScript VM必须在启动时加载TypeScript编译器，以便将TypeScript源代码即时转换为JavaScript。

截至两个月前发布的V8 v4.3，嵌入器可以利用快照来跳过这种初始化引起的启动时间。此功能的测试用例显示了此API的工作原理。

要创建快照，我们可以使用待嵌入脚本调用v8 :: V8 :: CreateSnapshotDataBlob作为以null结尾的C字符串。创建新上下文后，将编译并执行此脚本。在我们的例子中，我们创建了两个自定义启动快照，每个都在JavaScript内置的函数之上定义函数。

然后我们可以使用v8 :: Isolate :: CreateParams来配置新创建的隔离，以便从自定义启动快照初始化上下文。在该隔离中创建的上下文是我们拍摄快照的上下文的精确副本。快照中定义的功能无需再次定义即可使用。这有一个重要的限制：快照只能捕获V8的堆。创建快照时，V8与外部的任何交互都是被禁止的。

这种互动包括： 定义和调用API回调（即通过v8 :: FunctionTemplate创建的函数）

创建类型化数组，因为后备存储可以在V8之外分配。

当然，一旦捕获了快照，从Math.random或Date.now等源派生的值就会被修复。它们不再是随机的，也不反映当前时间。

除了限制之外，启动快照仍然是节省初始化时间的好方法。我们可以在上面的示例中（在常规台式计算机上）从加载TypeScript编译器的启动中减去100毫秒。我们期待看到您如何使用自定义快照！